在对一个分布式系统进行架构设计的过程中，往往会在系统的可用性和数据一致性之间进行反复权衡，于是就产生了一系列的一致性协议。  

在分布式系统中，一个机器节点虽然都能明确地知道自己在进行事务操作过程中的结果是成功或失败，但却无法直接获取到其他分布式节点的操作结果。因此，当一个
事务操作需要跨越多个分布式节点的时候，为了保持事务处理的ACID特性，就需要引入一个称为“协调者（Coordinator）”的组件来统一调度所有分布式节点的执行
逻辑，这些被调度的分布式节点则被称为“参与者（Participant）”。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务真正进行提交。  
基于这个思想，衍生出了2PC和3PC两种协议。  

### 1.2PC协议
Two-Phase Commit，二阶段提交。目前，大部分的关系型数据库都采用2PC来完成分布式事务处理。  

#### 执行流程
2PC是将事务的提交过程分为了两个阶段。  

##### 阶段一：提交事务请求
（1）事务询问  
协调者向所有参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。  

（2）执行事务  
各参与者节点执行事务操作，并将Undo和Redo信息记入事务日志中。  

（3）各参与者向协调者反馈事务询问的响应  
如果参与者成功执行了事务操作，则反馈协调者Yes响应，表示事务可以执行。  
如果没有成功执行事务，反馈给协调者No响应，表示事务不可以执行。  

上面内容在形式上近似是协调者组织各参与者对一次事务操作的投票表态过程，因此2PC的第一阶段也称为“投票阶段”，即各参与者投票表明是否要继续执行接下去的
事务提交操作。  

##### 阶段二：执行事务提交
本阶段中，协调者会根据各参与者的反馈情况来决定最终是否可以进行事务提交操作，正常情况下，包含以下两种可能：  
###### 执行事务提交
假如协调者收到的都是Yes响应，那么执行事务提交。  
（1）发送提交请求  
协调者向所有参与者发送commit请求。  
（2）事务提交  
参与者接到请求后，正式执行事务提交操作，并在完成后释放在整个事务执行期间占用的事务资源。  
（3）反馈事务提交结果  
参与者完成提交后，向协调者发送Ack消息。  
（4）完成事务  
协调者接收到所有参与者反馈的Ack消息后，完成事务。  

###### 中断事务
假如任何一个参与者向协调者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。  
（1）发送回滚请求  
协调者向所有参与者节点发出Rollback请求。  
（2）事务回滚  
参与者接到请求后，利用其在阶段一记录的Undo信息执行事务回滚操作，完成后释放资源。  
（3）反馈回滚结果  
参与者完成回滚后，向协调者发送ack消息。  
（4）中断事务
协调者接收到所有参与者反馈的ack后，完成事务中断。  

##### 总结
2PC将一个事务的处理过程分为了投票和执行两个阶段，其核心是对每个事务都采用先尝试后提交的处理方式，因此可以将2PC提交看成一个强一致性的算法。  

![成功](https://upload-images.jianshu.io/upload_images/2818100-c3acbccfef4f3081.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  

![回滚](https://upload-images.jianshu.io/upload_images/2818100-7726b9d8d330bc6c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  

###### 优点
原理简单、实现方便。  

###### 缺点
同步阻塞、单点问题、脑裂、太过保守。  


### 2.3PC协议
3PC是在2PC的基础上进行了改进后的协议。  
3PC将2PC的阶段二提交协议的“提交事务请求”过程分为了两部分，形成由CanCommit、PreCommit和doCommit三个阶段组成的事务处理协议。  
![3PC协议](https://upload-images.jianshu.io/upload_images/2818100-ddb72b894306b8f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  

#### 阶段一：CanCommit
（1）事务询问  
协调者向所有参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待各参与者的响应。  
（2）参与者反馈  
参与者接收到请求后，如果自身认为可以顺利执行事务，反馈Yes，并进入预备状态。否则反馈No响应。  

#### 阶段二：PreCommit
协调者根据参与者反馈情况决定是否可以进行事务的PreCommit操作，包含两种可能：  
##### 执行事务预提交
假设协调者收到的全是Yes，那么执行事务预提交。  
（1）发送预提交请求  
协调者向所有参与者发送preCommit请求，并进入prepared状态。  
（2）事务预提交  
参与者接收到preCommit后，执行事务操作，并将Undo和Redo信息记录到事务日志中。  
（3）参与者反馈  
如果参与者成功执行事务操作，反馈给协调者ack响应，同时等待最终指令：commit或abort。  

##### 中断事务
假设任何一个参与者向协调者反馈了No，或在等待超时后，协调者无法接收到所有参与者的反馈，那么就中断事务。  
（1）发送中断请求  
协调者向所有参与者节点发出abort请求。  
（2）中断事务  
无论是收到abort，还是等待协调者请求过程中出现超时，参与者都会中断事务。  

#### 阶段三：doCommit
进行真正的事务提交，存在以下两种可能。  
##### 执行提交
（1）发送提交请求  
假设协调者处于正常工作状态，且它接收到了来自所有参与者的ack响应，那么它将从“预提交”状态转换到“提交”状态，并向所有参与者发送doCommit请求。  
（2）事务提交  
参与者接收到后，执行事务提交操作，完成后释放资源。  
（3）反馈事务提交结果  
参与者完成事务提交后，向协调者发送ack消息。  
（4）完成事务  
协调者接收到所有参与者的ack后，完成事务。  

##### 中断事务
若任意一个参与者反馈No响应，或等待超时，就中断事务。  
（1）发送中断请求  
协调者发送abort请求。  
（2）事务回滚  
参与者利用Undo信息执行回滚操作，并释放资源。  
（3）反馈回滚结果  
参与者向协调者发送ack消息。  
（4）中断事务  
协调者接收到所有ack后，中断事务。  

#### 总结
##### 优点
相较于2PC，3PC降低了参与者的阻塞范围，且能够在出现单点故障后继续达成一致。  

##### 缺点
3PC在去除阻塞的同时引入了新的问题，即参与者接收到preCommit后，如果网络出现分区，此时协调者所在节点和参与者无法进行正常网络通信，这种情况下，
该参与者依然会进行事务提交，这会导致数据的不一致。  

















